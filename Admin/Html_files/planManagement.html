
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plan Management - Prepaid Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="../stylesheet/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="sidebar">
  <div class="hamburger"><i class="fas fa-bars"></i></div>
  <div class="sidebar-header"><h4>RechargeFlow Admin</h4></div>
  <hr/>
  <a href="#" class="menu-item" id="dashboard"><i class="fas fa-home"></i><span>Dashboard</span></a>
  <a href="#" class="menu-item" id="user-management"><i class="fas fa-users"></i><span>User Management</span></a>
  <a href="#" class="menu-item active" id="plan-management"><i class="fas fa-tags"></i><span>Plan Management</span></a>
  <a href="#" class="menu-item" id="transaction"><i class="fas fa-exchange-alt"></i><span>Transactions</span></a>
  <a href="#" class="menu-item" id="support"><i class="fas fa-headset"></i><span>Support</span></a>
  <a href="#" class="menu-item" id="analysis"><i class="fas fa-chart-line"></i><span>Analysis</span></a>
  <a href="#" class="menu-item logout-item" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
</div>

<div class="content">
  <div class="top-bar">
    <h2 class="top-bar-title">Plan Management</h2>
    <div class="top-bar-actions">
      <div class="search-box"><i class="fas fa-search"></i><input type="text" class="form-control" placeholder="Search plans..."></div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlanModal"><i class="fas fa-plus me-2"></i>Add New Plan</button>
      <div class="user-actions">
        <div class="icon-btn" id="notification-btn" data-bs-toggle="modal" data-bs-target="#notificationModal"><i class="fas fa-bell"></i></div>
        <div class="icon-btn" id="profile-btn" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="fas fa-user"></i></div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card" onclick="showTable('active')">
        <div class="card-flex">
          <div class="card-icon" style="background: rgba(76, 201, 240, 0.1); color: #4CC9F0;"><i class="fas fa-tag"></i></div>
          <div class="card-body"><h3 id="active-plan-count">4</h3><p>Active Plans</p></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-flex">
          <div class="card-icon" style="background: rgba(255, 184, 0, 0.1); color: #FFB800;"><i class="fas fa-star"></i></div>
          <div class="card-body"><h3 id="popular-plan">Premium</h3><p>Most Popular</p></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-flex">
          <div class="card-icon" style="background: rgba(67, 97, 238, 0.1); color: #4361EE;"><i class="fas fa-users"></i></div>
          <div class="card-body"><h3 id="subscription-count">1458</h3><p>Active Subscriptions</p></div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <div class="table-header">
      <h5 class="mb-0" id="table-title">Available Plans</h5>
      <div class="d-flex gap-2">
        <select class="form-select form-select-sm" id="statusFilter">
          <option value="all">All Plans</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
        <button class="btn btn-sm btn-primary" id="export-btn">Export</button>
      </div>
    </div>
    <table class="table">
      <thead><tr><th>Plan Name</th><th>Price</th><th>Data</th><th>Validity</th><th>Features</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="plans-table"></tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addPlanModalLabel">Add New Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addPlanForm">
          <div class="row g-3">
            <div class="col-md-6"><label for="planName" class="form-label">Plan Name</label><input type="text" class="form-control" id="planName" required></div>
            <div class="col-md-6"><label for="planPrice" class="form-label">Price (â‚¹)</label><input type="number" class="form-control" id="planPrice" required></div>
            <div class="col-md-6"><label for="planData" class="form-label">Data Allowance</label><input type="text" class="form-control" id="planData" placeholder="e.g. 10GB" required></div>
            <div class="col-md-6"><label for="planValidity" class="form-label">Validity (Days)</label><input type="number" class="form-control" id="planValidity" required></div>
            <div class="col-md-12"><label for="planFeatures" class="form-label">Features</label><textarea class="form-control" id="planFeatures" rows="3" placeholder="Enter plan features, one per line"></textarea></div>
            <div class="col-md-6"><label for="planStatus" class="form-label">Status</label><select class="form-select" id="planStatus"><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="savePlanBtn">Save Plan</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="updatePlanModal" tabindex="-1" aria-labelledby="updatePlanModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updatePlanModalLabel">Update Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updatePlanForm">
          <div class="mb-3">
            <label for="searchPlan" class="form-label">Plan Name</label>
            <input type="text" class="form-control" id="searchPlan" placeholder="Enter plan name" required>
          </div>
        </form>
        <div id="planResult" class="mt-3" style="display: none;">
          <p id="planDetails"></p>
          <select class="form-select mb-3" id="updatePlanStatus">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
          <button class="btn btn-primary" id="updatePlanStatusBtn">Update Status</button>
        </div>
        <div id="errorMessage" class="mt-3 text-danger" style="display: none;">Plan not present in database</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notificationModalLabel">High Priority Notifications</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group list-group-flush" id="notification-list">
          <li class="list-group-item d-flex justify-content-between align-items-center">User #123: Payment Failure<span class="status-badge status-warning">Urgent</span></li>
          <li class="list-group-item d-flex justify-content-between align-items-center">User #456: Service Complaint<span class="status-badge status-danger">Critical</span></li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="window.location.href='./support.html'">View All Support Tickets</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileModalLabel">Admin Profile</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="profile-form">
          <div class="mb-3"><label for="admin-name" class="form-label">Name</label><input type="text" class="form-control" id="admin-name" value="Admin User" required></div>
          <div class="mb-3"><label for="admin-phone" class="form-label">Phone Number</label><input type="tel" class="form-control" id="admin-phone" value="+91 9876543210" pattern="[0-9]{10}" required></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-profile-btn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editPlanModal" tabindex="-1" aria-labelledby="editPlanModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPlanModalLabel">Edit Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editPlanForm">
          <div class="row g-3">
            <div class="col-md-6"><label for="editPlanName" class="form-label">Plan Name</label><input type="text" class="form-control" id="editPlanName" required></div>
            <div class="col-md-6"><label for="editPlanPrice" class="form-label">Price (â‚¹)</label><input type="number" class="form-control" id="editPlanPrice" required></div>
            <div class="col-md-6"><label for="editPlanData" class="form-label">Data Allowance</label><input type="text" class="form-control" id="editPlanData" required></div>
            <div class="col-md-6"><label for="editPlanValidity" class="form-label">Validity (Days)</label><input type="number" class="form-control" id="editPlanValidity" required></div>
            <div class="col-md-12"><label for="editPlanFeatures" class="form-label">Features</label><textarea class="form-control" id="editPlanFeatures" rows="3"></textarea></div>
            <div class="col-md-6"><label for="editPlanStatus" class="form-label">Status</label><select class="form-select" id="editPlanStatus"><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveEditPlanBtn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let plans = [
    { name: "Basic Plan", price: "â‚¹9.99", data: "2GB", validity: "30 days", features: "Unlimited calls to same network, 100 SMS", status: "active" },
    { name: "Standard Plan", price: "â‚¹19.99", data: "5GB", validity: "30 days", features: "Unlimited calls to all networks, 500 SMS", status: "active" },
    { name: "Premium Plan", price: "â‚¹29.99", data: "15GB", validity: "30 days", features: "Unlimited calls, Unlimited SMS, 2GB social media data", status: "active" },
    { name: "Ultimate Plan", price: "â‚¹49.99", data: "50GB", validity: "30 days", features: "Unlimited everything, 10GB roaming data", status: "active" },
    { name: "Weekend Special", price: "â‚¹5.99", data: "3GB", validity: "2 days", features: "Weekend only, Unlimited social media", status: "inactive" }
  ];

  function updateCounts() {
    document.getElementById('active-plan-count').textContent = plans.filter(p => p.status === 'active').length;
    document.getElementById('subscription-count').textContent = plans.reduce((sum, p) => sum + (p.status === 'active' ? 300 : 0), 0); // Mock subscription count
  }

  function showTable(status) {
    document.getElementById('table-title').textContent = status === 'active' ? 'Active Plans' : status === 'inactive' ? 'Inactive Plans' : 'All Plans';
    const filteredPlans = status === 'all' ? plans : plans.filter(p => p.status === status);
    const tableBody = document.getElementById('plans-table');
    tableBody.innerHTML = filteredPlans.map(p => {
      const statusClass = p.status === 'active' ? 'status-active' : 'status-inactive';
      return `<tr><td><strong>${p.name}</strong></td><td>${p.price}</td><td>${p.data}</td><td>${p.validity}</td><td>${p.features}</td><td><span class="status-badge ${statusClass}">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}</span></td><td><button class="btn btn-sm btn-primary me-1 edit-plan" data-name="${p.name}"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger delete-plan" data-name="${p.name}"><i class="fas fa-trash"></i></button></td></tr>`;
    }).join('');
  }

  function setupNavigation() {
    const navLinks = {"user-management": "./userManagement.html", "plan-management": "./planManagement.html", "dashboard": "./dashboard.html", "transaction": "./Transaction.html", "analysis": "./analysis.html", "support": "./support.html"};
    Object.keys(navLinks).forEach(id => document.getElementById(id).addEventListener("click", (e) => { e.preventDefault(); window.location.href = navLinks[id]; }));
  }

  function setupSidebarToggle() {
    const hamburger = document.querySelector('.hamburger'), sidebar = document.querySelector('.sidebar'), content = document.querySelector('.content');
    hamburger.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); content.classList.toggle('expanded'); });
  }

  function setupPlanManagement() {
    document.getElementById('savePlanBtn').addEventListener('click', () => {
      const name = document.getElementById('planName').value;
      const price = `â‚¹${document.getElementById('planPrice').value}`;
      const data = document.getElementById('planData').value;
      const validity = `${document.getElementById('planValidity').value} days`;
      const features = document.getElementById('planFeatures').value;
      const status = document.getElementById('planStatus').value;
      if (name && price && data && validity) {
        plans.push({ name, price, data, validity, features: features || "No additional features", status });
        updateCounts();
        showTable(document.getElementById('statusFilter').value);
        bootstrap.Modal.getInstance(document.getElementById('addPlanModal')).hide();
      }
    });

    document.getElementById('searchPlan').addEventListener('input', (e) => {
      const value = e.target.value;
      const planResult = document.getElementById('planResult');
      const errorMessage = document.getElementById('errorMessage');

      planResult.style.display = 'none';
      errorMessage.style.display = 'none';

      if (value.length > 0) {
        const plan = plans.find(p => p.name.toLowerCase() === value.toLowerCase());
        if (plan) {
          planResult.style.display = 'block';
          document.getElementById('planDetails').textContent = `Plan Found: ${plan.name} - Current Status: ${plan.status.charAt(0).toUpperCase() + plan.status.slice(1)}`;
          document.getElementById('updatePlanStatus').value = plan.status;
          document.getElementById('updatePlanStatusBtn').onclick = () => {
            plan.status = document.getElementById('updatePlanStatus').value;
            updateCounts();
            showTable(document.getElementById('statusFilter').value);
            bootstrap.Modal.getInstance(document.getElementById('updatePlanModal')).hide();
          };
        } else {
          errorMessage.style.display = 'block';
        }
      }
    });

    document.getElementById('save-profile-btn').addEventListener('click', () => {
      const name = document.getElementById('admin-name').value;
      const phone = document.getElementById('admin-phone').value;
      if (name && phone.match(/^[0-9]{10}$/)) {
        localStorage.setItem('adminProfile', JSON.stringify({ name, phone }));
        alert('Profile updated successfully!');
        bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
      } else {
        alert('Please enter valid name and 10-digit phone number');
      }
    });

    const storedProfile = localStorage.getItem('adminProfile');
    if (storedProfile) {
      const profile = JSON.parse(storedProfile);
      document.getElementById('admin-name').value = profile.name;
      document.getElementById('admin-phone').value = profile.phone;
    }

    document.getElementById('export-btn').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(18);
      doc.setTextColor(67, 97, 238);
      doc.text('RechargeFlow - Plan Report', 10, 20);
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 10, 30);
      doc.text(`Filter: ${document.getElementById('statusFilter').options[document.getElementById('statusFilter').selectedIndex].text}`, 10, 40);

      const tableData = plans.filter(p => document.getElementById('statusFilter').value === 'all' || p.status === document.getElementById('statusFilter').value)
              .map(p => [p.name, p.price, p.data, p.validity, p.features, p.status.charAt(0).toUpperCase() + p.status.slice(1)]);

      doc.autoTable({
        startY: 50,
        head: [['Plan Name', 'Price', 'Data', 'Validity', 'Features', 'Status']],
        body: tableData,
        theme: 'grid',
        styles: { fontSize: 10, cellPadding: 3, textColor: [33, 37, 41] },
        headStyles: { fillColor: [67, 97, 238], textColor: [255, 255, 255] },
        alternateRowStyles: { fillColor: [248, 249, 250] },
        margin: { top: 50 }
      });

      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text('Â© RechargeFlow', 10, doc.internal.pageSize.height - 10);
      doc.save(`RechargeFlow_Plan_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    });

    document.getElementById('plans-table').addEventListener('click', (e) => {
      if (e.target.closest('.edit-plan')) {
        const name = e.target.closest('.edit-plan').dataset.name;
        const plan = plans.find(p => p.name === name);
        document.getElementById('editPlanName').value = plan.name;
        document.getElementById('editPlanPrice').value = plan.price.replace('â‚¹', '');
        document.getElementById('editPlanData').value = plan.data;
        document.getElementById('editPlanValidity').value = plan.validity.replace(' days', '');
        document.getElementById('editPlanFeatures').value = plan.features;
        document.getElementById('editPlanStatus').value = plan.status;

        const modal = new bootstrap.Modal(document.getElementById('editPlanModal'));
        modal.show();

        document.getElementById('saveEditPlanBtn').onclick = () => {
          plan.name = document.getElementById('editPlanName').value;
          plan.price = `â‚¹${document.getElementById('editPlanPrice').value}`;
          plan.data = document.getElementById('editPlanData').value;
          plan.validity = `${document.getElementById('editPlanValidity').value} days`;
          plan.features = document.getElementById('editPlanFeatures').value || "No additional features";
          plan.status = document.getElementById('editPlanStatus').value;
          updateCounts();
          showTable(document.getElementById('statusFilter').value);
          modal.hide();
        };
      }

      if (e.target.closest('.delete-plan')) {
        const name = e.target.closest('.delete-plan').dataset.name;
        if (confirm(`Are you sure you want to delete the plan "${name}"?`)) {
          plans = plans.filter(p => p.name !== name);
          updateCounts();
          showTable(document.getElementById('statusFilter').value);
        }
      }
    });

    document.getElementById('statusFilter').addEventListener('change', (e) => showTable(e.target.value));
  }

  document.getElementById("logout-btn").addEventListener("click", function (e) {
    e.preventDefault();
    const loadingOverlay = document.createElement("div");
    loadingOverlay.classList.add("position-fixed", "top-0", "start-0", "w-100", "h-100", "bg-dark", "bg-opacity-50", "d-flex", "justify-content-center", "align-items-center", "text-white", "fs-4");
    loadingOverlay.innerHTML = "Logging out...";
    document.body.appendChild(loadingOverlay);
    setTimeout(() => {
      localStorage.removeItem("loggedIns");
      document.body.removeChild(loadingOverlay);
      window.location.href = "../Html_files/login.html";
    }, 2000);
  });

  document.addEventListener('DOMContentLoaded', () => {
    setupNavigation();
    setupSidebarToggle();
    setupPlanManagement();
    updateCounts();
    showTable('all');

    if (window.location.hash === '#add-plan') {
      const addPlanModal = new bootstrap.Modal(document.getElementById('addPlanModal'));
      addPlanModal.show();
    }
  });
</script>
</body>
</html>