<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions - Prepaid Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../stylesheet/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="sidebar">
    <div class="hamburger"><i class="fas fa-bars"></i></div>
    <div class="sidebar-header"><h4>RechargeFlow Admin</h4></div>
    <hr/>
    <a href="#" class="menu-item" id="dashboard"><i class="fas fa-home"></i><span>Dashboard</span></a>
    <a href="#" class="menu-item" id="user-management"><i class="fas fa-users"></i><span>User Management</span></a>
    <a href="#" class="menu-item" id="plan-management"><i class="fas fa-tags"></i><span>Plan Management</span></a>
    <a href="#" class="menu-item active" id="transaction"><i class="fas fa-exchange-alt"></i><span>Transactions</span></a>
    <a href="#" class="menu-item" id="support"><i class="fas fa-headset"></i><span>Support</span></a>
    <a href="#" class="menu-item" id="analysis"><i class="fas fa-chart-line"></i><span>Analysis</span></a>
    <a href="#" class="menu-item logout-item" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
</div>

<div class="content">
    <div class="top-bar">
        <h2 class="top-bar-title">Transactions</h2>
        <div class="top-bar-actions">
            <div class="search-box"><i class="fas fa-search"></i><input type="text" class="form-control" placeholder="Search transactions..." id="searchTransaction"></div>
            <button class="btn btn-primary" id="export-btn"><i class="fas fa-download me-2"></i>Export</button>
            <div class="user-actions">
                <div class="icon-btn" id="notification-btn" data-bs-toggle="modal" data-bs-target="#notificationModal"><i class="fas fa-bell"></i></div>
                <div class="icon-btn" id="profile-btn" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="fas fa-user"></i></div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3 col-sm-6"><div class="card"><div class="card-flex"><div class="card-icon" style="background: rgba(76, 201, 240, 0.1); color: #4CC9F0;"><i class="fas fa-wallet"></i></div><div class="card-body"><h3 id="total-revenue">₹127K</h3><p>Total Revenue (Month)</p></div></div></div></div>
        <div class="col-md-3 col-sm-6"><div class="card"><div class="card-flex"><div class="card-icon" style="background: rgba(247, 37, 133, 0.1); color: #F72585;"><i class="fas fa-receipt"></i></div><div class="card-body"><h3 id="transaction-count">1,482</h3><p>Transactions (Month)</p></div></div></div></div>
        <div class="col-md-3 col-sm-6"><div class="card"><div class="card-flex"><div class="card-icon" style="background: rgba(255, 184, 0, 0.1); color: #FFB800;"><i class="fas fa-money-bill-wave"></i></div><div class="card-body"><h3 id="avg-transaction">₹85.75</h3><p>Avg Transaction</p></div></div></div></div>
        <div class="col-md-3 col-sm-6"><div class="card"><div class="card-flex"><div class="card-icon" style="background: rgba(67, 97, 238, 0.1); color: #4361EE;"><i class="fas fa-arrow-trend-up"></i></div><div class="card-body"><h3 id="growth-rate">+12.5%</h3><p>Growth Rate</p></div></div></div></div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3"><label for="dateRange" class="form-label">Date Range</label><select class="form-select" id="dateRange"><option value="today">Today</option><option value="yesterday">Yesterday</option><option value="last7days">Last 7 Days</option><option value="last30days" selected>Last 30 Days</option><option value="thisMonth">This Month</option><option value="lastMonth">Last Month</option><option value="custom">Custom Range</option></select></div>
                <div class="col-md-3"><label for="paymentStatus" class="form-label">Payment Status</label><select class="form-select" id="paymentStatus"><option value="all" selected>All Statuses</option><option value="successful">Successful</option><option value="pending">Pending</option><option value="failed">Failed</option><option value="refunded">Refunded</option></select></div>
                <div class="col-md-3"><label for="paymentMethod" class="form-label">Payment Method</label><select class="form-select" id="paymentMethod"><option value="all" selected>All Methods</option><option value="creditCard">Credit Card</option><option value="bankTransfer">Bank Transfer</option><option value="paypal">PayPal</option><option value="wallet">Digital Wallet</option></select></div>
                <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary w-100" id="apply-filters">Apply Filters</button></div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <div class="table-header"><h5 class="mb-0">Recent Transactions</h5><div class="d-flex gap-2"><select class="form-select form-select-sm" id="recordsPerPage"><option value="5">5 per page</option><option value="10" selected>10 per page</option><option value="25">25 per page</option><option value="50">50 per page</option></select></div></div>
        <table class="table">
            <thead><tr><th>Transaction ID</th><th>Customer</th><th>Date & Time</th><th>Amount</th><th>Plan</th><th>Payment Method</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="transactions-table"></tbody>
        </table>
        <div class="d-flex justify-content-between align-items-center p-3" id="pagination-container">
            <div>Showing <span id="showing-records">1-10</span> of <span id="total-records">8</span> records</div>
            <div class="pagination-container" id="pagination-buttons"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notificationModalLabel">High Priority Notifications</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="list-group list-group-flush" id="notification-list">
                    <li class="list-group-item d-flex justify-content-between align-items-center">User #123: Payment Failure<span class="status-badge status-warning">Urgent</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">User #456: Service Complaint<span class="status-badge status-danger">Critical</span></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="window.location.href='./support.html'">View All Support Tickets</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">Admin Profile</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div class="mb-3"><label for="admin-name" class="form-label">Name</label><input type="text" class="form-control" id="admin-name" value="Admin User" required></div>
                    <div class="mb-3"><label for="admin-phone" class="form-label">Phone Number</label><input type="tel" class="form-control" id="admin-phone" value="+91 9876543210" pattern="[0-9]{10}" required></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-profile-btn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="transactionDetailsModal" tabindex="-1" aria-labelledby="transactionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionDetailsModalLabel">Transaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="transactionDetailsContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let transactions = [
        { id: "TRX-12345", customer: "karthik", date: "2025-02-24 14:23:45", amount: "₹59.99", plan: "Premium Plan", method: "Credit Card", status: "successful" },
        { id: "TRX-12346", customer: "siva", date: "2025-02-24 12:15:33", amount: "₹29.99", plan: "Standard Plan", method: "PayPal", status: "successful" },
        { id: "TRX-12347", customer: "fazil", date: "2025-02-23 18:45:12", amount: "₹99.99", plan: "Ultimate Plan", method: "Bank Transfer", status: "pending" },
        { id: "TRX-12348", customer: "dilip", date: "2025-02-23 09:22:10", amount: "₹9.99", plan: "Basic Plan", method: "Digital Wallet", status: "successful" },
        { id: "TRX-12349", customer: "kalai", date: "2025-02-22 16:08:55", amount: "₹19.99", plan: "Standard Plan", method: "Credit Card", status: "failed" },
        { id: "TRX-12350", customer: "madhav", date: "2025-02-22 11:30:42", amount: "₹59.99", plan: "Premium Plan", method: "PayPal", status: "successful" },
        { id: "TRX-12351", customer: "safthar", date: "2025-02-21 20:17:33", amount: "₹29.99", plan: "Standard Plan", method: "Digital Wallet", status: "successful" },
        { id: "TRX-12352", customer: "abishek", date: "2025-02-21 15:45:18", amount: "₹9.99", plan: "Basic Plan", method: "Credit Card", status: "refunded" }
    ];

    let currentPage = 1;

    function updateStats() {
        const filteredTransactions = filterTransactions();
        const totalRevenue = filteredTransactions.reduce((sum, t) => sum + parseFloat(t.amount.replace('₹', '')), 0).toFixed(2);
        const transactionCount = filteredTransactions.length;
        const avgTransaction = transactionCount ? (totalRevenue / transactionCount).toFixed(2) : 0;
        const growthRate = transactionCount ? ((transactionCount / 1482) * 100 - 100).toFixed(1) : 0;

        document.getElementById('total-revenue').textContent = `₹${totalRevenue}K`;
        document.getElementById('transaction-count').textContent = transactionCount;
        document.getElementById('avg-transaction').textContent = `₹${avgTransaction}`;
        document.getElementById('growth-rate').textContent = `${growthRate > 0 ? '+' : ''}${growthRate}%`;
    }

    function filterTransactions() {
        const dateRange = document.getElementById('dateRange').value;
        const paymentStatus = document.getElementById('paymentStatus').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const searchQuery = document.getElementById('searchTransaction').value.toLowerCase();

        const today = new Date();
        const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
        const last7Days = new Date(today); last7Days.setDate(today.getDate() - 7);
        const last30Days = new Date(today); last30Days.setDate(today.getDate() - 30);
        const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);

        return transactions.filter(t => {
            const tDate = new Date(t.date);
            const matchesSearch = t.id.toLowerCase().includes(searchQuery) || t.customer.toLowerCase().includes(searchQuery);
            const matchesStatus = paymentStatus === 'all' || t.status === paymentStatus;
            const matchesMethod = paymentMethod === 'all' || t.method.toLowerCase().replace(' ', '') === paymentMethod;
            let matchesDate = true;

            switch (dateRange) {
                case 'today': matchesDate = tDate.toDateString() === today.toDateString(); break;
                case 'yesterday': matchesDate = tDate.toDateString() === yesterday.toDateString(); break;
                case 'last7days': matchesDate = tDate >= last7Days; break;
                case 'last30days': matchesDate = tDate >= last30Days; break;
                case 'thisMonth': matchesDate = tDate >= thisMonthStart; break;
                case 'lastMonth': matchesDate = tDate >= lastMonthStart && tDate <= lastMonthEnd; break;
            }

            return matchesSearch && matchesStatus && matchesMethod && matchesDate;
        });
    }

    function populateTransactionsTable() {
        const filteredTransactions = filterTransactions();
        const recordsPerPage = parseInt(document.getElementById('recordsPerPage').value);
        const totalRecords = filteredTransactions.length;
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        currentPage = Math.min(currentPage, totalPages || 1);

        const start = (currentPage - 1) * recordsPerPage;
        const end = Math.min(start + recordsPerPage, totalRecords);
        const paginatedTransactions = filteredTransactions.slice(start, end);

        document.getElementById('transactions-table').innerHTML = paginatedTransactions.map(t => {
            const statusClass = t.status === 'successful' ? 'status-active' : t.status === 'pending' || t.status === 'refunded' ? 'status-warning' : 'status-inactive';
            return `<tr><td><strong>${t.id}</strong></td><td>${t.customer}</td><td>${t.date}</td><td>${t.amount}</td><td>${t.plan}</td><td>${t.method}</td><td><span class="status-badge ${statusClass}">${t.status.charAt(0).toUpperCase() + t.status.slice(1)}</span></td><td><button class="btn btn-sm btn-outline-primary me-1 view-details" data-id="${t.id}" title="View Details"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-outline-secondary download-receipt" data-id="${t.id}" title="Download Receipt"><i class="fas fa-download"></i></button></td></tr>`;
        }).join('');

        document.getElementById('showing-records').textContent = `${start + 1}-${end}`;
        document.getElementById('total-records').textContent = totalRecords;
        updatePagination(totalPages);
    }

    function updatePagination(totalPages) {
        const pagination = document.getElementById('pagination-buttons');
        pagination.innerHTML = `
            <button class="btn btn-sm btn-outline-secondary me-2" ${currentPage === 1 ? 'disabled' : ''} id="prev-page"><i class="fas fa-chevron-left"></i></button>
            ${Array.from({ length: totalPages }, (_, i) => `
                <button class="btn btn-sm ${currentPage === i + 1 ? 'btn-primary' : 'btn-outline-secondary'} me-1" data-page="${i + 1}">${i + 1}</button>
            `).join('')}
            <button class="btn btn-sm btn-outline-secondary" ${currentPage === totalPages ? 'disabled' : ''} id="next-page"><i class="fas fa-chevron-right"></i></button>
        `;

        document.getElementById('prev-page')?.addEventListener('click', () => { if (currentPage > 1) { currentPage--; populateTransactionsTable(); } });
        document.getElementById('next-page')?.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; populateTransactionsTable(); } });
        document.querySelectorAll('.pagination-container button[data-page]').forEach(btn =>
            btn.addEventListener('click', () => { currentPage = parseInt(btn.dataset.page); populateTransactionsTable(); })
        );
    }

    function setupNavigation() {
        const navLinks = {"user-management": "./userManagement.html", "plan-management": "./planManagement.html", "dashboard": "./dashboard.html", "transaction": "./Transaction.html", "analysis": "./analysis.html", "support": "./support.html"};
        Object.keys(navLinks).forEach(id => document.getElementById(id).addEventListener("click", (e) => { e.preventDefault(); window.location.href = navLinks[id]; }));
    }

    function setupSidebarToggle() {
        const hamburger = document.querySelector('.hamburger'), sidebar = document.querySelector('.sidebar'), content = document.querySelector('.content');
        hamburger.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); content.classList.toggle('expanded'); });
    }

    function setupTransactions() {

        document.getElementById('apply-filters').addEventListener('click', () => {
            currentPage = 1;
            populateTransactionsTable();
            updateStats();
        });


        document.getElementById('recordsPerPage').addEventListener('change', () => {
            currentPage = 1;
            populateTransactionsTable();
        });


        document.getElementById('searchTransaction').addEventListener('input', () => {
            currentPage = 1;
            populateTransactionsTable();
            updateStats();
        });

        document.getElementById('save-profile-btn').addEventListener('click', () => {
            const name = document.getElementById('admin-name').value;
            const phone = document.getElementById('admin-phone').value;
            if (name && phone.match(/^[0-9]{10}$/)) {
                localStorage.setItem('adminProfile', JSON.stringify({ name, phone }));
                alert('Profile updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            } else {
                alert('Please enter valid name and 10-digit phone number');
            }
        });
        const storedProfile = localStorage.getItem('adminProfile');
        if (storedProfile) {
            const profile = JSON.parse(storedProfile);
            document.getElementById('admin-name').value = profile.name;
            document.getElementById('admin-phone').value = profile.phone;
        }

        document.getElementById('export-btn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.setTextColor(67, 97, 238);
            doc.text('RechargeFlow - Transaction Report', 10, 20);
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 10, 30);
            doc.text(`Filter: ${document.getElementById('paymentStatus').options[document.getElementById('paymentStatus').selectedIndex].text}, ${document.getElementById('dateRange').options[document.getElementById('dateRange').selectedIndex].text}`, 10, 40);

            const tableData = filterTransactions().map(t => [t.id, t.customer, t.date, t.amount, t.plan, t.method, t.status.charAt(0).toUpperCase() + t.status.slice(1)]);
            doc.autoTable({
                startY: 50,
                head: [['Transaction ID', 'Customer', 'Date & Time', 'Amount', 'Plan', 'Payment Method', 'Status']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 3, textColor: [33, 37, 41] },
                headStyles: { fillColor: [67, 97, 238], textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [248, 249, 250] },
                margin: { top: 50 }
            });

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('© RechargeFlow', 10, doc.internal.pageSize.height - 10);
            doc.save(`RechargeFlow_Transaction_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        });

        document.getElementById('transactions-table').addEventListener('click', (e) => {
            const id = e.target.closest('.view-details')?.dataset.id || e.target.closest('.download-receipt')?.dataset.id;
            if (!id) return;
            const transaction = transactions.find(t => t.id === id);

            if (e.target.closest('.view-details')) {
                document.getElementById('transactionDetailsContent').innerHTML = `
                    <p><strong>Transaction ID:</strong> ${transaction.id}</p>
                    <p><strong>Customer:</strong> ${transaction.customer}</p>
                    <p><strong>Date & Time:</strong> ${transaction.date}</p>
                    <p><strong>Amount:</strong> ${transaction.amount}</p>
                    <p><strong>Plan:</strong> ${transaction.plan}</p>
                    <p><strong>Payment Method:</strong> ${transaction.method}</p>
                    <p><strong>Status:</strong> ${transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1)}</p>
                `;
                const modal = new bootstrap.Modal(document.getElementById('transactionDetailsModal'));
                modal.show();
            } else if (e.target.closest('.download-receipt')) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18);
                doc.setTextColor(67, 97, 238);
                doc.text('RechargeFlow - Transaction Receipt', 10, 20);
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Transaction ID: ${transaction.id}`, 10, 30);
                doc.text(`Date: ${transaction.date}`, 10, 40);
                doc.text(`Customer: ${transaction.customer}`, 10, 50);
                doc.text(`Amount: ${transaction.amount}`, 10, 60);
                doc.text(`Plan: ${transaction.plan}`, 10, 70);
                doc.text(`Payment Method: ${transaction.method}`, 10, 80);
                doc.text(`Status: ${transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1)}`, 10, 90);
                doc.text('© RechargeFlow', 10, doc.internal.pageSize.height - 10);
                doc.save(`Receipt_${transaction.id}.pdf`);
            }
        });
    }

    document.getElementById("logout-btn").addEventListener("click", function (e) {
        e.preventDefault();
        const loadingOverlay = document.createElement("div");
        loadingOverlay.classList.add("position-fixed", "top-0", "start-0", "w-100", "h-100", "bg-dark", "bg-opacity-50", "d-flex", "justify-content-center", "align-items-center", "text-white", "fs-4");
        loadingOverlay.innerHTML = "Logging out...";
        document.body.appendChild(loadingOverlay);
        setTimeout(() => {
            localStorage.removeItem("loggedIns");
            document.body.removeChild(loadingOverlay);
            window.location.href = "../Html_files/login.html";
        }, 2000);
    });

    document.addEventListener('DOMContentLoaded', () => {
        setupNavigation();
        setupSidebarToggle();
        setupTransactions();
        updateStats();
        populateTransactionsTable();
    });
</script>
</body>
</html>