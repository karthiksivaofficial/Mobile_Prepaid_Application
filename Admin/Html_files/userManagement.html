<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - Prepaid Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="../stylesheet/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="sidebar">
  <div class="hamburger"><i class="fas fa-bars"></i></div>
  <div class="sidebar-header"><h4>RechargeFlow Admin</h4></div>
  <hr/>
  <a href="#" class="menu-item" id="dashboard"><i class="fas fa-home"></i><span>Dashboard</span></a>
  <a href="#" class="menu-item active" id="user-management"><i class="fas fa-users"></i><span>User Management</span></a>
  <a href="#" class="menu-item" id="plan-management"><i class="fas fa-tags"></i><span>Plan Management</span></a>
  <a href="#" class="menu-item" id="transaction"><i class="fas fa-exchange-alt"></i><span>Transactions</span></a>
  <a href="#" class="menu-item" id="support"><i class="fas fa-headset"></i><span>Support</span></a>
  <a href="#" class="menu-item" id="analysis"><i class="fas fa-chart-line"></i><span>Analysis</span></a>
  <a href="#" class="menu-item logout-item" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
</div>

<div class="content">
  <div class="top-bar">
    <h2 class="top-bar-title">User Management</h2>
    <div class="top-bar-actions">
      <div class="search-box"><i class="fas fa-search"></i><input type="text" class="form-control" placeholder="Search users..."></div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#updateUserModal"><i class="fas fa-plus me-2"></i>Update User</button>
      <div class="user-actions">
        <div class="icon-btn" id="notification-btn" data-bs-toggle="modal" data-bs-target="#notificationModal"><i class="fas fa-bell"></i></div>
        <div class="icon-btn" id="profile-btn" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="fas fa-user"></i></div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card" id="active-card" onclick="showTable('active')">
        <div class="card-flex">
          <div class="card-icon" style="background: rgba(76, 201, 240, 0.1); color: #4CC9F0;"><i class="fas fa-user-check"></i></div>
          <div class="card-body"><h3 id="active-count">2</h3><p>Active Users</p></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card" id="expiry-card" onclick="showTable('expiring')">
        <div class="card-flex">
          <div class="card-icon" style="background: rgba(255, 184, 0, 0.1); color: #FFB800;"><i class="fas fa-calendar-times"></i></div>
          <div class="card-body"><h3 id="expiry-count">1</h3><p>Expiring Soon</p></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card" id="inactive-card" onclick="showTable('inactive')">
        <div class="card-flex">
          <div class="card-icon" style="background: rgba(247, 37, 133, 0.1); color: #F72585;"><i class="fas fa-user-times"></i></div>
          <div class="card-body"><h3 id="inactive-count">1</h3><p>Inactive Users</p></div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive" id="table-container">
    <div class="table-header">
      <h5 class="mb-0" id="table-title">User List</h5>
      <div class="d-flex gap-2">
        <select class="form-select form-select-sm" id="statusFilter">
          <option value="all">All Users</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="expiring">Expiring Soon</option>
          <option value="blocked">Blocked</option>
        </select>
        <button class="btn btn-sm btn-primary" id="export-btn">Export</button>
      </div>
    </div>
    <table class="table">
      <thead><tr><th>Name</th><th>Phone Number</th><th>Plan</th><th>Expiry Date</th><th>Last Transaction</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>
</div>


<div class="modal fade" id="updateUserModal" tabindex="-1" aria-labelledby="updateUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateUserModalLabel">Update User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updateUserForm">
          <div class="mb-3">
            <label for="searchUser" class="form-label">Username/Phone Number</label>
            <input type="text" class="form-control" id="searchUser" placeholder="Enter username or phone" required>
          </div>
        </form>
        <div id="userResult" class="mt-3" style="display: none;">
          <p id="userDetails"></p>
          <select class="form-select mb-3" id="updateStatus">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="expiring">Expiring Soon</option>
            <option value="blocked">Blocked</option>
          </select>
          <button class="btn btn-primary" id="updateUserStatusBtn">Update Status</button>
        </div>
        <div id="errorMessage" class="mt-3 text-danger" style="display: none;">Number not present in database</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addUserForm">
          <div class="row g-3">
            <div class="col-md-6"><label for="userName" class="form-label">Full Name</label><input type="text" class="form-control" id="userName" required></div>
            <div class="col-md-6"><label for="userPhone" class="form-label">Phone Number</label><input type="tel" class="form-control" id="userPhone" required></div>
            <div class="col-md-6"><label for="userPlan" class="form-label">Select Plan</label><select class="form-select" id="userPlan" required><option value="">Choose a plan</option><option value="basic">Basic Plan</option><option value="standard">Standard Plan</option><option value="premium">Premium Plan</option><option value="ultimate">Ultimate Plan</option></select></div>
            <div class="col-md-6"><label for="userStatus" class="form-label">Status</label><select class="form-select" id="userStatus"><option value="active">Active</option><option value="inactive">Inactive</option><option value="expiring">Expiring Soon</option><option value="blocked">Blocked</option></select></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveUserBtn">Save User</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notificationModalLabel">High Priority Notifications</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group list-group-flush" id="notification-list">
          <li class="list-group-item d-flex justify-content-between align-items-center">User #123: Payment Failure<span class="status-badge status-warning">Urgent</span></li>
          <li class="list-group-item d-flex justify-content-between align-items-center">User #456: Service Complaint<span class="status-badge status-danger">Critical</span></li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="window.location.href='./support.html'">View All Support Tickets</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileModalLabel">Admin Profile</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="profile-form">
          <div class="mb-3"><label for="admin-name" class="form-label">Name</label><input type="text" class="form-control" id="admin-name" value="Admin User" required></div>
          <div class="mb-3"><label for="admin-phone" class="form-label">Phone Number</label><input type="tel" class="form-control" id="admin-phone" value="+91 9876543210" pattern="[0-9]{10}" required></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-profile-btn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statusChangeModalLabel">Change User Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>User: <span id="statusUserName"></span> (<span id="statusUserPhone"></span>)</p>
        <select class="form-select" id="newStatus">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="expiring">Expiring Soon</option>
          <option value="blocked">Blocked</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveStatusBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let users = [
    { name: "karthik", phone: "1234567890", plan: "Basic Plan", expiry: "2025-03-15", lastTransaction: "2025-02-01", amount: "₹100", status: "active" },
    { name: "siva", phone: "9876543210", plan: "Premium Plan", expiry: "2025-02-25", lastTransaction: "2025-01-15", amount: "₹200", status: "active" },
    { name: "fazil", phone: "5556667777", plan: "Standard Plan", expiry: "2025-05-10", lastTransaction: "2025-02-05", amount: "₹150", status: "inactive" },
    { name: "kalai", phone: "3334445555", plan: "Basic Plan", expiry: "2025-02-20", lastTransaction: "2025-01-28", amount: "₹120", status: "expiring" }
  ];

  function updateCounts() {
    document.getElementById('active-count').textContent = users.filter(u => u.status === 'active').length;
    document.getElementById('expiry-count').textContent = users.filter(u => u.status === 'expiring').length;
    document.getElementById('inactive-count').textContent = users.filter(u => u.status === 'inactive' || u.status === 'blocked').length;
  }

  function showTable(status) {
    document.getElementById('table-title').textContent = status === 'active' ? 'Active Users' : status === 'expiring' ? 'Users Expiring Soon' : status === 'inactive' ? 'Inactive Users' : status === 'blocked' ? 'Blocked Users' : 'All Users';
    const filteredUsers = status === 'all' ? users : users.filter(u => u.status === status);
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = filteredUsers.map(u => {
      const statusClass = u.status === 'active' ? 'status-active' : u.status === 'inactive' ? 'status-inactive' : u.status === 'blocked' ? 'status-danger' : 'status-warning';
      return `<tr><td>${u.name}</td><td>${u.phone}</td><td>${u.plan}</td><td>${u.expiry}</td><td>${u.lastTransaction}</td><td>${u.amount}</td><td><span class="status-badge ${statusClass}">${u.status.charAt(0).toUpperCase() + u.status.slice(1)}</span></td><td><button class="btn btn-sm btn-primary edit-status" data-phone="${u.phone}"><i class="fas fa-edit"></i></button></td></tr>`;
    }).join('');
    document.getElementById('table-container').style.display = 'block';
  }

  function setupNavigation() {
    const navLinks = {"user-management": "./userManagement.html", "plan-management": "./planManagement.html", "dashboard": "./dashboard.html", "transaction": "./Transaction.html", "analysis": "./analysis.html", "support": "./support.html"};
    Object.keys(navLinks).forEach(id => document.getElementById(id).addEventListener("click", (e) => { e.preventDefault(); window.location.href = navLinks[id]; }));
  }

  function setupSidebarToggle() {
    const hamburger = document.querySelector('.hamburger'), sidebar = document.querySelector('.sidebar'), content = document.querySelector('.content');
    hamburger.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); content.classList.toggle('expanded'); });
  }

  function setupUserManagement() {

    const searchUserInput = document.getElementById('searchUser');
    searchUserInput.addEventListener('input', (e) => {
      const value = e.target.value;
      const userResult = document.getElementById('userResult');
      const errorMessage = document.getElementById('errorMessage');

      userResult.style.display = 'none';
      errorMessage.style.display = 'none';

      if (value.length === 10 && /^\d{10}$/.test(value)) {
        const user = users.find(u => u.phone === value || u.name === value);
        if (user) {
          userResult.style.display = 'block';
          document.getElementById('userDetails').textContent = `User Found: ${user.name} (${user.phone}) - Current Status: ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}`;
          document.getElementById('updateStatus').value = user.status;
          document.getElementById('updateUserStatusBtn').onclick = () => {
            user.status = document.getElementById('updateStatus').value;
            updateCounts();
            showTable(document.getElementById('statusFilter').value);
            bootstrap.Modal.getInstance(document.getElementById('updateUserModal')).hide();
          };
        } else {
          errorMessage.style.display = 'block';
        }
      }
    });

    document.getElementById('saveUserBtn').addEventListener('click', () => {
      const name = document.getElementById('userName').value;
      const phone = document.getElementById('userPhone').value;
      const plan = document.getElementById('userPlan').value;
      const status = document.getElementById('userStatus').value;
      if (name && phone && plan && status) {
        users.push({ name, phone, plan, expiry: "2025-12-31", lastTransaction: new Date().toISOString().split('T')[0], amount: "₹0", status });
        updateCounts();
        showTable(status);
        bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
      }
    });

    document.getElementById('save-profile-btn').addEventListener('click', () => {
      const name = document.getElementById('admin-name').value;
      const phone = document.getElementById('admin-phone').value;
      if (name && phone.match(/^[0-9]{10}$/)) {
        localStorage.setItem('adminProfile', JSON.stringify({ name, phone }));
        alert('Profile updated successfully!');
        bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
      } else {
        alert('Please enter valid name and 10-digit phone number');
      }
    });


    const storedProfile = localStorage.getItem('adminProfile');
    if (storedProfile) {
      const profile = JSON.parse(storedProfile);
      document.getElementById('admin-name').value = profile.name;
      document.getElementById('admin-phone').value = profile.phone;
    }


    document.getElementById('export-btn').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();


      doc.setFontSize(18);
      doc.setTextColor(67, 97, 238);
      doc.text('RechargeFlow - User Report', 10, 20);
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 10, 30);
      doc.text(`Filter: ${document.getElementById('statusFilter').options[document.getElementById('statusFilter').selectedIndex].text}`, 10, 40);

      const tableData = users.filter(u => document.getElementById('statusFilter').value === 'all' || u.status === document.getElementById('statusFilter').value)
              .map(u => [u.name, u.phone, u.plan, u.expiry, u.lastTransaction, u.amount, u.status.charAt(0).toUpperCase() + u.status.slice(1)]);

      doc.autoTable({
        startY: 50,
        head: [['Name', 'Phone', 'Plan', 'Expiry', 'Last Transaction', 'Amount', 'Status']],
        body: tableData,
        theme: 'grid',
        styles: { fontSize: 10, cellPadding: 3, textColor: [33, 37, 41] },
        headStyles: { fillColor: [67, 97, 238], textColor: [255, 255, 255] },
        alternateRowStyles: { fillColor: [248, 249, 250] },
        margin: { top: 50 }
      });

      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text('© RechargeFlow', 10, doc.internal.pageSize.height - 10);

      doc.save(`RechargeFlow_User_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    });

    document.getElementById('table-body').addEventListener('click', (e) => {
      if (e.target.closest('.edit-status')) {
        const phone = e.target.closest('.edit-status').dataset.phone;
        const user = users.find(u => u.phone === phone);
        document.getElementById('statusUserName').textContent = user.name;
        document.getElementById('statusUserPhone').textContent = user.phone;
        document.getElementById('newStatus').value = user.status;
        const modal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
        modal.show();

        document.getElementById('saveStatusBtn').onclick = () => {
          user.status = document.getElementById('newStatus').value;
          updateCounts();
          showTable(document.getElementById('statusFilter').value);
          modal.hide();
        };
      }
    });

    document.getElementById('statusFilter').addEventListener('change', (e) => showTable(e.target.value));
  }

  document.getElementById("logout-btn").addEventListener("click", function (e) {
    e.preventDefault();
    const loadingOverlay = document.createElement("div");
    loadingOverlay.classList.add("position-fixed", "top-0", "start-0", "w-100", "h-100", "bg-dark", "bg-opacity-50", "d-flex", "justify-content-center", "align-items-center", "text-white", "fs-4");
    loadingOverlay.innerHTML = "Logging out...";
    document.body.appendChild(loadingOverlay);
    setTimeout(() => {
      localStorage.removeItem("loggedIns");
      document.body.removeChild(loadingOverlay);
      window.location.href = "../Html_files/login.html";
    }, 2000);
  });

  document.addEventListener('DOMContentLoaded', () => {
    setupNavigation();
    setupSidebarToggle();
    setupUserManagement();
    updateCounts();
    showTable('active');
  });
</script>
</body>
</html>